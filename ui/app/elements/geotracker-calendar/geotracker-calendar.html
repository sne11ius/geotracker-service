<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="geotracker-calendar" attributes="">
  <template>
    <link rel="stylesheet" href="geotracker-calendar.css">
    <geotracker-globals id="globals"></geotracker-globals>
    <core-header-panel flex>
      <core-toolbar>
        <paper-tabs selected="{{selected}}" noink>
          <paper-tab>Calendar</paper-tab>
          <paper-tab>Locations</paper-tab>
        </paper-tabs>
      </core-toolbar>
      <template if="{{0 == selected}}">
        <div id="calendar"></div>
      </template>
      <template if="{{1 == selected}}">
      <geotracker-location-list baseUrl="/mit/geotracker-service"></geotracker-location-list>
      </template>
    </core-header-panel>
    <template if="{{1 == selected}}">
      <paper-fab id="add-location-button" icon="add" on-click="{{addLocationClicked}}"></paper-fab>
    </template>
  </template>
  <script>
    (function () {
      Polymer({
        selected: 0,
        selectedChanged: function() {
          $(this.$.calendar).fullCalendar('render');
        },
        isInvalid: function(value) { return false; },
        attached: function() {
          $(this.$.calendar).fullCalendar({
            header: {
              left: 'prev,next today',
              center: 'title',
              right: 'month,agendaWeek,agendaDay',
            },
            allDaySlot: false,
            defaultView: 'agendaWeek'
          });
          window.setTimeout(function() {
            $(this.$.calendar).fullCalendar('render');
          }, 500);
        },
        addLocationClicked: function() {
          this.$.globals.locationEditor._this = this;
          this.$.globals.locationEditor.addEventListener('save', this.saveLocationClicked);
          this.$.globals.locationEditor.addEventListener('close', this.locationEditorClosed);
          this.$.globals.locationEditor.reset();
          this.$.globals.locationEditor.open();
        },
        onCompleted: function() {
          console.log('oncompleted');
        },
        saveLocationClicked: function() {
          console.log('User clicked save');
          var _this = this._this;
          var location = _this.$.globals.locationEditor.location;
          console.log(location);
          if ('' === location.name) {
            var toast = document.createElement('paper-toast');
            toast.setAttribute('text', 'A location name is required.');
            document.body.appendChild(toast);
            toast.show();
            return;
          } else {
            console.log('now posting location...');
            _this.$.globals.locationEditor.close();
          }
        },
        locationEditorClosed: function() {
          console.log('dialog closed');
          this.removeEventListener('save', this._this.saveLocationClicked);
          this.removeEventListener('close', this._this.locationEditorClosed);
          this._this = undefined;
        }
      });
    })();
  </script>
</polymer-element>
